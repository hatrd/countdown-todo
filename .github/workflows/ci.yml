name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rust-tests:
    name: Rust + Invoke Contract Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run invoke contract tests
        run: node --test app/src/invoke-bridge.test.mjs

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: rust-tests

      - name: Run Rust tests
        run: cargo test --workspace

  windows-build:
    name: Windows EXE Build
    runs-on: windows-latest
    env:
      CARGO_TERM_COLOR: always
      RUSTC_WRAPPER: sccache
      SCCACHE_GHA_ENABLED: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: windows-msvc
          cache-on-failure: true

      - name: Add Windows target
        run: rustup target add x86_64-pc-windows-msvc

      - name: Install Tauri CLI (if missing)
        shell: pwsh
        run: |
          if (-not (Get-Command cargo-tauri -ErrorAction SilentlyContinue)) {
            cargo install tauri-cli --version '^1' --locked
          } else {
            cargo-tauri --version
          }

      - name: Build app (Windows, no bundle for non-tag)
        if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        run: cargo tauri build --features desktop --target x86_64-pc-windows-msvc --bundles none

      - name: Build Tauri app (Windows)
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        run: cargo tauri build --features desktop --target x86_64-pc-windows-msvc

      - name: Upload Windows installer artifacts
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/upload-artifact@v4
        with:
          name: countdown-todo-windows-bundle
          path: |
            target/**/bundle/nsis/*.exe
            target/**/bundle/msi/*.msi
          if-no-files-found: warn

      - name: Collect portable EXE
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path target -Recurse -File -Filter *.exe |
            Where-Object {
              $_.FullName -match '[\\/]release[\\/][^\\/]+\.exe$' -and
              $_.FullName -notmatch '[\\/]bundle[\\/]' -and
              $_.Name -notmatch '(?i)(setup|uninstall|msi|nsis)'
            } |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if (-not $exe) {
            Write-Host 'Candidate EXEs under target:'
            Get-ChildItem -Path target -Recurse -File -Filter *.exe | Select-Object -ExpandProperty FullName
            Write-Error 'Portable EXE not found under target/**/release/*.exe'
            exit 1
          }

          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Copy-Item $exe.FullName dist/countdown-todo-portable.exe -Force
          Write-Host "Portable EXE: $($exe.FullName)"

      - name: Upload portable EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: countdown-todo-portable-exe
          path: dist/countdown-todo-portable.exe
          if-no-files-found: error

      - name: Show sccache stats
        if: always()
        run: sccache --show-stats

  release-portable-exe:
    name: Release Portable EXE
    if: startsWith(github.ref, 'refs/tags/v')
    needs: windows-build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download portable artifact
        uses: actions/download-artifact@v4
        with:
          name: countdown-todo-portable-exe
          path: dist

      - name: Publish GitHub release asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/countdown-todo-portable.exe
          generate_release_notes: true
